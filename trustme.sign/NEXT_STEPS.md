# –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ TrustMe

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ:

1. –ú–æ–¥—É–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
2. Webhook –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ TrustMe (—Å—Ç–∞—Ç—É—Å: Ok)
3. URL webhook –¥–æ—Å—Ç—É–ø–µ–Ω: `https://crm.clevercrm.kz:443/webhook/trustme_webhook.php`
4. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook —Ä–∞–±–æ—Ç–∞–µ—Ç: `/bitrix/admin/trustme_sign_webhook_setup.php`

## ‚ö†Ô∏è –¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:

**–í TrustMe –Ω–µ—Ç –ø–æ–ª—è `deal_id` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞**

TrustMe –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç ID —Å–¥–µ–ª–∫–∏ –≤ webhook, –ø–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏.

## üîß –†–µ—à–µ–Ω–∏–µ: –ü–æ–∏—Å–∫ —Å–¥–µ–ª–∫–∏ –ø–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–º—É –ø–æ–ª—é

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ –≤ —Å–¥–µ–ª–∫–µ

1. –ó–∞–π–¥–∏—Ç–µ –≤ **CRM ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª–µ–π ‚Üí –°–¥–µ–ª–∫–∏**
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ –ø–æ–ª–µ:
   - **–¢–∏–ø**: –°—Ç—Ä–æ–∫–∞
   - **–ö–æ–¥**: `UF_CONTRACT_ID`
   - **–ù–∞–∑–≤–∞–Ω–∏–µ**: "ID –¥–æ–≥–æ–≤–æ—Ä–∞ TrustMe"
   - **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ**: –ù–µ—Ç (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –ø–æ–∑–∂–µ)

### –®–∞–≥ 2: –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```
1. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ –≤ TrustMe:
   - –ü–æ–ª—É—á–∞–µ—Ç–µ contract_id (–Ω–∞–ø—Ä–∏–º–µ—Ä: "bZE216Ds")
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç–µ –µ–≥–æ –≤ –ø–æ–ª–µ UF_CONTRACT_ID –Ω—É–∂–Ω–æ–π —Å–¥–µ–ª–∫–∏

2. –ö–æ–≥–¥–∞ TrustMe –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook:
   - Webhook –ø–æ–ª—É—á–∞–µ—Ç contract_id
   - –ò—â–µ—Ç —Å–¥–µ–ª–∫—É, –≥–¥–µ UF_CONTRACT_ID = contract_id
   - –ù–∞—Ö–æ–¥–∏—Ç –Ω—É–∂–Ω—É—é —Å–¥–µ–ª–∫—É
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å
```

### –®–∞–≥ 3: –î–æ—Ä–∞–±–æ—Ç–∞—Ç—å webhook

**–¢–µ–∫—É—â–∏–π –∫–æ–¥** –≤ `webhook/trustme_webhook.php` (—Å—Ç—Ä–æ–∫–∏ 87-105) –∏–º–µ–µ—Ç –∑–∞–≥–ª—É—à–∫—É:
- –°–µ–π—á–∞—Å –±–µ—Ä—ë—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
- –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∏—Å–∫ –ø–æ –ø–æ–ª—é `UF_CONTRACT_ID`

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**
–ó–∞–º–µ–Ω–∏—Ç—å –∫–æ–¥ –ø–æ–∏—Å–∫–∞ —Å–¥–µ–ª–∫–∏ –Ω–∞:

```php
// –ï—Å–ª–∏ deal_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –∏—â–µ–º —Å–¥–µ–ª–∫—É –ø–æ contract_id —á–µ—Ä–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ
if (empty($dealId)) {
    // –ò—â–µ–º —Å–¥–µ–ª–∫—É –ø–æ –ø–æ–ª—é UF_CONTRACT_ID
    $dbDeals = CCrmDeal::GetList(
        array('ID' => 'DESC'),
        array('UF_CONTRACT_ID' => $contractId), // –ü–æ–∏—Å–∫ –ø–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–º—É –ø–æ–ª—é
        false,
        array('nTopCount' => 1),
        array('ID', 'UF_CONTRACT_ID')
    );
    
    if ($deal = $dbDeals->Fetch()) {
        $dealId = $deal['ID'];
        file_put_contents($logFile, date('Y-m-d H:i:s') . " - Found deal #" . $dealId . " by UF_CONTRACT_ID = " . $contractId . "\n", FILE_APPEND);
    } else {
        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
        file_put_contents($logFile, date('Y-m-d H:i:s') . " - WARNING: Deal not found for contract_id = " . $contractId . "\n", FILE_APPEND);
    }
}
```

## üìã –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É TrustMe
- –ü–æ–ø—Ä–æ—Å–∏—Ç—å –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `deal_id` (–∏–ª–∏ `number_deal`) –≤ —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞
- –≠—Ç–æ —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç, –µ—Å–ª–∏ –æ–Ω–∏ —Å–æ–≥–ª–∞—Å—è—Ç—Å—è

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ–ª—è –¥–æ–≥–æ–≤–æ—Ä–∞
- –ï—Å–ª–∏ –≤ TrustMe –µ—Å—Ç—å –ø–æ–ª—è "–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞", "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" –∏ —Ç.–¥.
- –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å ID —Å–¥–µ–ª–∫–∏ —Ç—É–¥–∞ –∏ –∏—Å–∫–∞—Ç—å –ø–æ –Ω–∏–º

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

### 1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Å–¥–µ–ª–∫—É:
- –°–æ–∑–¥–∞–π—Ç–µ —Å–¥–µ–ª–∫—É –≤ Bitrix24
- –ó–∞–ø–∏—à–∏—Ç–µ –µ—ë ID (–Ω–∞–ø—Ä–∏–º–µ—Ä: 123)

### 2. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –¥–æ–≥–æ–≤–æ—Ä –≤ TrustMe:
- –°–æ–∑–¥–∞–π—Ç–µ –¥–æ–≥–æ–≤–æ—Ä –≤ TrustMe
- –ü–æ–ª—É—á–∏—Ç–µ `contract_id` (–Ω–∞–ø—Ä–∏–º–µ—Ä: "bZE216Ds")
- –í—Ä—É—á–Ω—É—é —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç ID –≤ –ø–æ–ª–µ `UF_CONTRACT_ID` —Å–¥–µ–ª–∫–∏ #123

### 3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å webhook:
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `test_webhook.php`:

```php
<?php
$webhookUrl = 'https://crm.clevercrm.kz:443/webhook/trustme_webhook.php';

$data = array(
    'contract_id' => 'bZE216Ds', // ID –¥–æ–≥–æ–≤–æ—Ä–∞ –∏–∑ TrustMe
    // deal_id –Ω–µ –ø–µ—Ä–µ–¥–∞—ë–º - webhook –¥–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏ –ø–æ UF_CONTRACT_ID
    'status' => 'created',
    'event' => 'contract_created'
);

$ch = curl_init($webhookUrl);
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/json'));
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

$response = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

echo "HTTP Code: " . $httpCode . "\n";
echo "Response: " . $response . "\n";
?>
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
- –§–∞–π–ª: `/trustme_webhook.log`
- –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–ø–∏—Å—å –æ –Ω–∞–π–¥–µ–Ω–Ω–æ–π —Å–¥–µ–ª–∫–µ

## üìù –í–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã:

- Webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫: `webhook/trustme_webhook.php`
- –ö–ª–∞—Å—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫: `lib/Options.php`
- –ö–ª–∞—Å—Å API: `lib/Api.php`
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: `admin/trustme_sign_webhook_setup.php`

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:

- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API TrustMe: https://trustmekz.docs.apiary.io/
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook: `https://crm.clevercrm.kz/bitrix/admin/trustme_sign_webhook_setup.php`
- URL webhook: `https://crm.clevercrm.kz:443/webhook/trustme_webhook.php`

## ‚ö° –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ webhook
tail -f /trustme_webhook.log

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å webhook
curl -X POST https://crm.clevercrm.kz:443/webhook/trustme_webhook.php
```

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-XX
**–°—Ç–∞—Ç—É—Å:** –û–∂–∏–¥–∞–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–∏—Å–∫–∞ –ø–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–º—É –ø–æ–ª—é

