# –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook

## ‚úÖ –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–¥—É–ª—è (–µ—Å–ª–∏ –µ—â—ë –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–∞–ø–∫—É `trustme.sign` –≤ `/bitrix/modules/`
2. –ó–∞–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω–∫—É Bitrix24: **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **Marketplace** ‚Üí **–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è**
3. –ù–∞–π–¥–∏—Ç–µ "Trust Me Sign" –∏ –Ω–∞–∂–º–∏—Ç–µ **"–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"**
4. –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ webhook-—Ñ–∞–π–ª –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤:
   - `/local/webhook/trustme_webhook.php`
   - `/webhook/trustme_webhook.php`

## ‚úÖ –®–∞–≥ 2: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ URL webhook

–í–∞—à URL webhook –±—É–¥–µ—Ç:
```
https://–≤–∞—à-–¥–æ–º–µ–Ω.ru/webhook/trustme_webhook.php
```

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:**
- –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ—Ç URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞ "Method not allowed" (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - –Ω—É–∂–µ–Ω POST-–∑–∞–ø—Ä–æ—Å)

## ‚úÖ –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook –≤ TrustMe

### –í–∞—Ä–∏–∞–Ω—Ç –ê: –ß–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É Bitrix24 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –ó–∞–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω–∫—É: **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **Trust Me Sign** ‚Üí **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook**
2. –í–≤–µ–¥–∏—Ç–µ:
   - **–¢–æ–∫–µ–Ω API**: –≤–∞—à —Ç–æ–∫–µ–Ω –æ—Ç TrustMe
   - **–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º**: –≤–∫–ª—é—á–∏—Ç–µ/–≤—ã–∫–ª—é—á–∏—Ç–µ
   - **URL Webhook**: —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ URL –∏–∑ —à–∞–≥–∞ 2
3. –ù–∞–∂–º–∏—Ç–µ **"–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Webhook"**
4. –ï—Å–ª–∏ –≤—Å—ë —É—Å–ø–µ—à–Ω–æ - —É–≤–∏–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ "Webhook —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"

### –í–∞—Ä–∏–∞–Ω—Ç –ë: –ß–µ—Ä–µ–∑ API (–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ)

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `setup_webhook.php` –≤ –∫–æ—Ä–Ω–µ —Å–∞–π—Ç–∞:

```php
<?php
require_once($_SERVER['DOCUMENT_ROOT'] . '/bitrix/modules/main/include/prolog_before.php');

CModule::IncludeModule('trustme.sign');

$apiToken = '–í–ê–®_–¢–û–ö–ï–ù_API';
$testMode = true; // false –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
$webhookUrl = 'https://–≤–∞—à-–¥–æ–º–µ–Ω.ru/webhook/trustme_webhook.php';

$api = new \TrustMe\Sign\Api($apiToken, $testMode);
$result = $api->setHook($webhookUrl);

if ($result) {
    echo "‚úÖ Webhook —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!\n";
} else {
    $error = $api->getLastError();
    echo "‚ùå –û—à–∏–±–∫–∞: " . $error['message'] . "\n";
}
?>
```

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä –∏–ª–∏ –∫–æ–º–∞–Ω–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É.

## ‚úÖ –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–∞

1. –ó–∞–π–¥–∏—Ç–µ –≤ **CRM** ‚Üí **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** ‚Üí **–ë–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã**
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω –ë–ü –¥–ª—è **"–°–¥–µ–ª–∫–∏"**
3. –î–æ–±–∞–≤—å—Ç–µ –∞–∫—Ç–∏–≤–∏—Ç–∏ **"Trust Me: –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–≥–æ–≤–æ—Ä–µ"**
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
   - **ApiToken**: –≤–∞—à —Ç–æ–∫–µ–Ω API (–∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –ë–ü)
   - **TestMode**: –î–∞/–ù–µ—Ç
   - **ContractId**: `{=Document:UF_CONTRACT_ID}` (–∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∏–∑ webhook)
   - **DealId**: `{=Document:ID}` (ID —Ç–µ–∫—É—â–µ–π —Å–¥–µ–ª–∫–∏)
5. **–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ** —à–∞–±–ª–æ–Ω –∏ **–∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ** –µ–≥–æ

## ‚úÖ –®–∞–≥ 5: –°–≤—è–∑—å —Å–¥–µ–ª–∫–∏ —Å –¥–æ–≥–æ–≤–æ—Ä–æ–º

Webhook –ø–æ–ª—É—á–∞–µ—Ç `contract_id` –∏ `deal_id`. –ï—Å–ª–∏ `deal_id` –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è:

1. –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –ø–æ–ª–µ –≤ —Å–¥–µ–ª–∫–µ:
   - **–¢–∏–ø**: –°—Ç—Ä–æ–∫–∞
   - **–ö–æ–¥**: `UF_CONTRACT_ID`
   - **–ù–∞–∑–≤–∞–Ω–∏–µ**: "ID –¥–æ–≥–æ–≤–æ—Ä–∞ TrustMe"

2. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ –≤ TrustMe —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ `contract_id` –≤ —ç—Ç–æ –ø–æ–ª–µ

3. Webhook –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å —Å–¥–µ–ª–∫—É –ø–æ —ç—Ç–æ–º—É –ø–æ–ª—é (–Ω—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–∏—Å–∫–∞)

## ‚úÖ –®–∞–≥ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 6.1. –¢–µ—Å—Ç webhook –≤—Ä—É—á–Ω—É—é

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `test_webhook.php`:

```php
<?php
$webhookUrl = 'https://–≤–∞—à-–¥–æ–º–µ–Ω.ru/webhook/trustme_webhook.php';

$data = array(
    'contract_id' => 'bZE216Ds', // –¢–µ—Å—Ç–æ–≤—ã–π ID
    'deal_id' => '123', // ID —Ç–µ—Å—Ç–æ–≤–æ–π —Å–¥–µ–ª–∫–∏
);

$ch = curl_init($webhookUrl);
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/json'));
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

$response = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

echo "HTTP Code: " . $httpCode . "\n";
echo "Response: " . $response . "\n";
?>
```

### 6.2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

–ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
- `/trustme_webhook.log` - –ª–æ–≥–∏ webhook
- –ñ—É—Ä–Ω–∞–ª –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ —Å–¥–µ–ª–∫–µ

### 6.3. –†–µ–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç

1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é —Å–¥–µ–ª–∫—É –≤ Bitrix24
2. –°–æ–∑–¥–∞–π—Ç–µ –¥–æ–≥–æ–≤–æ—Ä –≤ TrustMe —Å ID —ç—Ç–æ–π —Å–¥–µ–ª–∫–∏
3. TrustMe –æ—Ç–ø—Ä–∞–≤–∏—Ç webhook
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ë–ü –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∏ —Ç–æ–≤–∞—Ä—ã –¥–æ–±–∞–≤–∏–ª–∏—Å—å

## üîß –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å URL –∏–∑–≤–Ω–µ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ firewall
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ TrustMe

### –ë–ü –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `/trustme_webhook.log`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —à–∞–±–ª–æ–Ω –ë–ü –∞–∫—Ç–∏–≤–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∞–∫—Ç–∏–≤–∏—Ç–∏ –µ—Å—Ç—å –≤ —à–∞–±–ª–æ–Ω–µ

### –û—à–∏–±–∫–∞ "Deal not found"
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `deal_id` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ webhook
- –ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–∏—Å–∫ –ø–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–º—É –ø–æ–ª—é

